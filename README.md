# Selfinity Backend

Selfinity — инструмент самоанализа, основанный на расширенной версии колеса баланса. Приложение помогает фиксировать состояния по жизненным сферам, выявлять конкретные проблемы и подбирать для них простые действия.

## Концепция продукта

- **8 сфер внимания**: здоровье, духовность, друзья, любовь/семья, работа и доход, дом, развлечения, отдых.
- **Рабочие листы**: для каждой сферы хранятся оценка (0–100), конкретные проблемы и точечные решения 1:1 к проблемам.
- **Короткий цикл обратной связи**: пользователь еженедельно обновляет оценки и корректирует действия, превращая саморазвитие в управляемый процесс.
- **Ключевые сущности (план)**: пользователь → набор привычек/экшенов → логи выполнения и аналитика.

## Текущий статус

> Фаза 1: подготовлена базовая серверная инфраструктура. Реализован каркас FastAPI‑приложения с конфигурацией, подключением к БД, тестовой эндпоинтом `/health`, настройкой Alembic и pytest. Дальнейшие фазы добавят бизнес-логику, аутентификацию и фронтенд.

## Технологии

- **Язык**: Python 3.11+
- **Web/API**: FastAPI, Uvicorn
- **База данных**: PostgreSQL (asyncpg, SQLAlchemy 2.x, Alembic)
- **Тестирование**: pytest, pytest-asyncio, httpx
- **Контейнеризация**: Docker, docker-compose
- **Прочее**: pydantic-settings, Redis (запланировано по спецификации)

## Структура репозитория

```
backend/
├── app/
│   ├── api/           # Роуты FastAPI
│   ├── core/          # Конфигурация и база данных
│   ├── models/        # SQLAlchemy модели (база DeclarativeBase)
│   └── main.py        # Точка входа FastAPI
├── alembic/           # Скрипты миграций
├── tests/             # pytest-фикстуры и тесты
├── requirements.txt   # Python-зависимости
├── docker-compose.yml # Локальная разработка в контейнерах
├── Dockerfile         # Образ backend-сервиса
├── .env.example       # Пример переменных окружения
└── README.md
```

Дополнительные материалы (видение продукта, декомпозиция, стек) лежат в директории `doc/`.

## Подготовка окружения (без Docker)

1. **Создайте виртуальное окружение и поставьте зависимости**
   ```bash
   cd backend
   python -m venv .venv
   source .venv/bin/activate
   pip install -r requirements.txt
   ```

2. **Сконфигурируйте переменные окружения**
   ```bash
   cp .env.example .env
   ```
   Отредактируйте `DATABASE_URL` (формат `postgresql+asyncpg://USER:PASS@HOST:PORT/DB`).

3. **Запустите приложение**
   ```bash
   uvicorn app.main:app --reload
   ```
   Эндпоинт проверки готовности: `http://localhost:8000/health`.

## Запуск через Docker Compose

```bash
cd backend
docker compose up --build
```

Сервисы:
- `postgres` — PostgreSQL 15 (данные в томе `postgres_data`).
- `app` — FastAPI с автообновлением кода.

После старта API доступно по `http://localhost:8000/health`. Остановка: `docker compose down`.

## Миграции Alembic

1. Применить все миграции:
   ```bash
   alembic upgrade head
   ```
2. Сгенерировать новую миграцию (после изменений в моделях):
   ```bash
   alembic revision --autogenerate -m "describe change"
   ```
3. При необходимости отметить состояние без применения:
   ```bash
   alembic stamp head
   ```

> ⚠️ Перед автогенерацией убедитесь, что текущая база синхронизирована (`upgrade head`), иначе Alembic сообщит, что целевая БД не в актуальном состоянии.

## Тестирование

```bash
source .venv/bin/activate
pytest
```

Фикстуры используют in-memory SQLite (`sqlite+aiosqlite:///:memory:`), поэтому отдельная инфраструктура не нужна.

## Пример запроса

```bash
curl http://localhost:8000/health | jq
```

Ожидаемый ответ:

```json
{
  "status": "ok",
  "timestamp": "2025-10-10T15:06:00Z",
  "database": "connected"
}
```

## Дальнейшие шаги (согласно документации)

- Ввести модели пользователей, привычек и логов.
- Реализовать аутентификацию (JWT).
- Добавить Redis для кеша и сессий.
- Подготовить frontend (React + TypeScript + MUI/Tailwind).
- Настроить CI/CD и окружения AWS/GCP.

Вся детализация по этапам разработки — в `doc/phase-1.md` и соседних драйверах.
